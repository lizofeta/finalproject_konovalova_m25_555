# Платформа для отслеживания и симуляции торговли валютами 

Это комплексная платформа, которая позволяет пользователям регистрироваться, управлять своим виртуальным
портфелем фиатных и криптовалют, совершать сделки по покупке/продаже, а также отслеживать актуальные курсы 
в реальном времени. 

## Система состоит из двух основных сервисов:
1. **Сервис Парсинга** (Parser Service): Отдельное приложение, которое по запросу или расписанию обращается к публичным API, получает актуальные курсы, сравнивает их с предыдущими значениями и сохраняет историю в базу данных.
2. **Основной Сервис** (Core Service): Главное приложение, которое предоставляет пользовательский интерфейс (CLI), управляет пользователями, их кошельками, историей транзакций и взаимодействует с сервисом парсинга для получения актуальных курсов.

## Структура проекта:
```bush
valutatrade_hub/
    logging_config.py  # Настройка логирования
    decorators.py      # Декораторы
    cli/               # Интерфейс 
    core/              # Бизнес-логика и исключения
    infra/             # Инфраструктура: база данных, настройки
    parser_service/    # Сервис обновления курсов из внешних API
data/                  # JSON-хранилища курсов, пользователей и портфелей
logs/                  # Файлы логов 
.env.local             # Файл хранения API ключа для доступа к ExchangeRate-API
```

## Установка:
1. Убедитесь, что у Вас установлен python 3.12+ и Poetry
2. Клонируйте репозиторий и перейдите в корень проекта:

Клонирование:
```bush
git clone https://github.com/lizofeta/finalproject_konovalova_m25_555.git
```

Переход в корневую деректорию проекта:
```bush
cd finalproject_konovalova_m25_555
```

3. Установите зависимости пректа:
```bush
make install
```

## Запуск 

- Запустите приложение следующей командой:
```bush
make project
```

- После запуска вы сразу увидете подсказку по доступным командам и доступным валютам:

## Доступные команды: 

```bush
- register <username> <password> <initial_usd_amount>   # зарегистрироваться на платформе.
- login <username> <password>                           # выполнить вход в свой аккаунт.
- logout                                                # выйти из своего аккаунта.
- show-portfolio <base>                                 # показать все свои кошельки и итоговую стоимость в базовой валюте.
- buy <currency> <amount>                               # купить валюту.
- buy-usd <amount>                                      # пополнить USD кошелек из внешнего источника (имитация).
- sell <currency> <amount>                              # продать валюту.
- get-rate <from_currency> <to_currency>                # получить текущий курс одной валюты к другой.
- update-rates <source> (ciongecko/exchangerate) <base> # обновить курсы. Источник не указан = все.
- show-rates <currency> <base>                          # показать курс для указанной валюты по отношению к базовой.
- show-rates <top N> <base>                             # показать N самых дорогих криптовалют по отношению к базовой.
- help                                                  # посмотреть список доступных команд (данное сообщение).
- exit                                                  # выйти из приложения.
```

Базовая валюта по умолчанию - USD.

Доступные фиатные валюты: USD, RUB, EUR, IRR, GBP, KZT, CNY
Доступные криптовалюты: BTC, ETH, SOL

ВНИМАНИЕ! Во время регистрации необходимо совершить пополнение USD-кошелька. Кошелек создается автоматически при первой покупке валюты.

### Примеры команд

```bush
register vasya qwerty 100000
login vasya qwerty
buy EUR 100
sell RUB 1000
show-portfolio                  # показать все свои кошельки и итоговую стоимость в USD
show-portfolio EUR              # показать все свои кошельки и итоговую стоимость в EUR
get-rate RUB USD
update-rates                    # обновятся и фиантные, и криптовалюты, база - USD
update-rates coingecko          # обновятся только криптовалюты, база - USD 
update-rates EUR                # обновятся все валюты, база - EUR
update-rates exchangerate RUB   # обновятся только фиантные валюты, база - RUB
show-rates top 2                # покажет топ-2 криптовалюты по стоимости, база - USD
show-rates top 3 EUR            # покажет топ-3 криптовалюты по стоимости, база - EUR
```

## Кэш курсов, история обновлений курсов и TTL

- Актуальные курсы сохраняются в файл `data/rates.json`
- История обновлений курсов хранится в файле `data/exchange_rates.json`
- Время жизни (TTL) задается ключом `rates_ttl_seconds` в секции [tool.valutatrade] в файле `pyproject.toml`

При запросе курсов командой `get-rate` система проверяет, не устарели ли данные, и автоматически обновляет курсы.

## Parser Service

Сервис `Parser Service` обновляет локальный кэш актуальных курсов и ведет историю обновлений курсов, обращаясь к нескольким источникам: `CoinGecko`/`ExchangeRate-API`.

ВНИМАНИЕ! Для работы с `ExchangeRate-API` необходим API ключ!

- В корневой директории проекта найдите файл, названный `.env.local`.
- Переименуйте файл `.env.local` -> `.env`:
```bash
mv .env.local .env
```
- Откройте файл `.env` в текстовом редакторе:
```bush
nano .env
```
- В файле `.env` пропишите Ваш API ключ на месте `ВАШ_КЛЮЧ`:
```bush
API_KEY="ВАШ_КЛЮЧ"
```
-- Сохранить изменения -> `Ctrl + O`, `Enter`;  
-- Выйти -> `Ctrl + X`

## ASCIINEMA

### Демонстрация работы основных функций и обратобки ошибок

`register -> login -> show-portfolio -> buy -> sell -> get-rate`

Обработка ошибок:
- Неверный пароль.
- Имя пользователя занято (при регистрации).
- Недостаточно средств для совершения покупки.
- Отсутствие указанной валюты в реестре валют.
- Слишком короткий пароль (при регистрации).

[![asciicast](https://asciinema.org/a/H9Eo9UAVzSBkOhPg.svg)](https://asciinema.org/a/H9Eo9UAVzSBkOhPg)

### Демонстрация работы команд `update-rates` и `show-rates`

[![asciicast](https://asciinema.org/a/czMyhxikJuUSbDwq.svg)](https://asciinema.org/a/czMyhxikJuUSbDwq)